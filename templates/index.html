<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NBT Gen</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <!-- minify -->
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
    <!-- latest -->
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <!-- core style only -->
    <link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Dark mode color overrides -->
    <style>
      @media (prefers-color-scheme: dark) {
        :root {
          --bs-body-bg: #111827;
          --bs-body-color: #F9FAFB;
          --bs-primary: #3B82F6;
          --bs-secondary: #64748B;
          --bs-success: #22D3EE;
          --bs-danger: #F472B6;
          --bs-warning: #FBBF24;
          --bs-info: #A78BFA;
          --bs-light: #1F2937;
          --bs-dark: #0B1120;
          --bs-card-bg: var(--bs-light);
          --aurora-horizontal: linear-gradient(90deg,#22d3ee 0%,#a78bfa 100%);
          --aurora-diagonal: linear-gradient(135deg,#84cc16 0%,#f472b6 100%);
        }
      }
    </style>
    <style>
      html, body, pre, code, kbd, samp {
          font-family: "Press Start 2P", system-ui;
      }
    </style>
    <!-- Theme customization -->
    <style>
      :root {
        /* Light theme defaults */
        --bs-body-bg: #ffffff;
        --bs-body-color: #000000;
        --bs-card-bg: #ffffff;
        --bs-primary: #3B82F6;
        --bs-secondary: #64748B;
      }
      .dark-mode {
        /* Dark theme overrides */
        --bs-body-bg: #111827;
        --bs-body-color: #D1D5DB;
        --bs-card-bg: #1F2937;
      }
      body {
        background-color: var(--bs-body-bg) !important;
        color: var(--bs-body-color) !important;
      }
      .card {
        background-color: var(--bs-card-bg) !important;
      }
      /* Dark mode fixes */
      .dark-mode .nes-container {
        background-color: #1F2937 !important;
        color: #D1D5DB !important;
      }
      .dark-mode .nes-container.with-title > .title {
        background-color: #1F2937 !important;
        color: #F9FAFB !important;
      }
      .dark-mode a {
        color: #60A5FA !important;
      }
      .dark-mode .text-muted {
        color: #9CA3AF !important;
      }
      /* Loading animation */
      @keyframes blink {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0; }
      }
      .loading-dots {
        display: inline-block;
        animation: blink 1s infinite;
      }
      .btn-loading {
        position: relative;
        pointer-events: none;
      }
      .status-message {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.9rem;
        min-height: 1.5rem;
      }
      .dark-mode .status-message {
        color: #9CA3AF;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <h2 class="display-5 text-center mb-4 text-primary">Never-Before-Thought Generator</h2>
      <p class="lead text-center text-secondary mb-4">
        Enter any topic and uncover a fresh, mind-bending ‚Äúwhat-if‚Äù nobody‚Äôs ever thought. Dive into bold, coherent ideas that challenge the usual and ignite new possibilities.
      </p>
      <div class="text-end mb-4">
        <button id="theme-toggle" class="btn btn-outline-secondary">üåô Dark Mode</button>
      </div>
      <div class="row justify-content-center mx-1">
        <div class="nes-container with-title is-centered">
          <p class="title">github: <a href="https://github.com/sanaro99/NBT-Gen" target="_blank">sanaro99/NBT-Gen</a></p>
          <form action="/generate" method="post" class="mb-4">
            <div class="nes-field mb-4 is-inline">
              <label for="topic">Topic</label>
              <input type="text" name="topic" id="topic" class="form-control" placeholder="Enter a topic (e.g. quantum tunnelling)" required value="{{ topic or '' }}">
            </div>
          <div class="nes-field my-4 is-inline">
            <label for="wildness">Wildness (<span id="wildness-value" class="text-muted">{{ wildness or 50 }}</span>)</label>
            <input type="range" name="wildness" id="wildness" class="form-range" min="0" max="100" value="{{ wildness or 50 }}">
          </div>
          <div class="mt-4 d-flex justify-content-center">
            <button type="submit" class="nes-btn is-primary" id="generate-btn">
              <span class="btn-text">Generate</span>
              <span class="loading-text" style="display: none;">
                Generating<span class="loading-dots">...</span>
              </span>
            </button>
          </div>
          <div class="status-message" id="status-message"></div>
        </form>
        {% if idea %}
        <hr>
        <div class="mt-4">
          <h5 class="card-title">üí° New thought</h5>
          <p class="card-text" style="white-space: pre-line;">{{ idea }}</p>
          <p class="text-muted">Novelty score: {{ '%.2f' | format(novelty) }}</p>
          <p class="text-muted">Coherence score: {{ '%.2f' | format(coherence) }}</p>
        </div>
        {% endif %}
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const wildnessInput = document.getElementById('wildness');
        const wildnessValue = document.getElementById('wildness-value');
        wildnessValue.textContent = wildnessInput.value;
        wildnessInput.addEventListener('input', () => wildnessValue.textContent = wildnessInput.value);
        
        const form = document.querySelector('form');
        const btn = document.getElementById('generate-btn');
        const btnText = btn.querySelector('.btn-text');
        const loadingText = btn.querySelector('.loading-text');
        const statusMessage = document.getElementById('status-message');
        
        let isStreaming = false;
        
        form.addEventListener('submit', (e) => {
          if (isStreaming) return;
          
          e.preventDefault();
          isStreaming = true;
          
          const topic = document.getElementById('topic').value;
          const wildness = document.getElementById('wildness').value;
          
          btn.classList.add('is-disabled', 'btn-loading');
          btn.setAttribute('disabled', 'disabled');
          btnText.style.display = 'none';
          loadingText.style.display = 'inline';
          statusMessage.textContent = 'Starting...';
          
          const eventSource = new EventSource(`/generate-stream?topic=${encodeURIComponent(topic)}&wildness=${wildness}`);
          
          eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'status') {
              statusMessage.textContent = data.message;
            } else if (data.type === 'result') {
              eventSource.close();
              statusMessage.textContent = 'Complete! Refreshing...';
              // Submit form to get rendered result
              setTimeout(() => {
                isStreaming = false;
                form.submit();
              }, 500);
            } else if (data.type === 'error') {
              eventSource.close();
              statusMessage.textContent = 'Error: ' + data.message;
              btn.classList.remove('is-disabled', 'btn-loading');
              btn.removeAttribute('disabled');
              btnText.style.display = 'inline';
              loadingText.style.display = 'none';
              isStreaming = false;
            }
          };
          
          eventSource.onerror = () => {
            eventSource.close();
            statusMessage.textContent = 'Connection error. Submitting...';
            setTimeout(() => {
              isStreaming = false;
              form.submit();
            }, 1000);
          };
        });
        
        // Theme toggle setup
        const themeBtn = document.getElementById('theme-toggle');
        const rootEl = document.body;
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme === 'dark') {
          rootEl.classList.add('dark-mode');
          themeBtn.textContent = '‚òÄÔ∏è Light Mode';
        } else {
          rootEl.classList.remove('dark-mode');
          themeBtn.textContent = 'üåô Dark Mode';
        }
        themeBtn.addEventListener('click', () => {
          if (rootEl.classList.contains('dark-mode')) {
            rootEl.classList.remove('dark-mode');
            themeBtn.textContent = 'üåô Dark Mode';
            localStorage.setItem('theme', 'light');
          } else {
            rootEl.classList.add('dark-mode');
            themeBtn.textContent = '‚òÄÔ∏è Light Mode';
            localStorage.setItem('theme', 'dark');
          }
        });
      });
    </script>
  </body>
</html>